---
title: "Low-quality Cells Validation"
output: html_document
---

```{r global_options, include=FALSE}
library(ggplot2)
library(ggpubr)
library(ggrastr)
library(dplyr)
library(parallel)
library(Seurat)
library(dropestr)
library(dropEstAnalysis)


theme_set(theme_base)

set.seed(42)
kDatasetName <- 'SCG71'

# kPlotsFolder <- paste0('/d0-mendel/home/viktor_petukhov/Data/Plots/PaperReview/LowQualityCells/', kDatasetName, '/')
```

```{r}
kDataPath <- '../../data/dropest/SCG71/est_11_14_poisson_real/'
holder <- readRDS(paste0(kDataPath, 'SCG71.rds'))
# genesets <- readRDS('/d0-mendel/home/viktor_petukhov/cp/data/genesets_mouse.rds')
```

```{r}
est_cell_num <- EstimateCellsNumber(holder$aligned_umis_per_cell)
umis_per_cell <- sort(holder$aligned_umis_per_cell, decreasing=T)
```

```{r}
scores <- ScorePipelineCells(holder, mit.chromosome.name='chrM', predict.all=T, verbose=T)[names(umis_per_cell)]
PlotCellScores(scores)
```

```{r}
intersect_cbs <- names(scores[1:est_cell_num$expected])
intersect_cbs <- intersect_cbs[scores[intersect_cbs] > 0.9]

unknown_cell_scores <- scores[(est_cell_num$expected+1):length(scores)]
rescued_cbs <- names(unknown_cell_scores)[unknown_cell_scores > 0.9]

unknown_cell_scores <- scores[1:est_cell_num$expected]
filtered_cbs <- names(unknown_cell_scores)[unknown_cell_scores < 0.1]

c(length(intersect_cbs), length(rescued_cbs), length(filtered_cbs))
```

```{r}
r_cm_rescued <- holder$cm_raw[, c(names(umis_per_cell)[1:est_cell_num$expected], rescued_cbs)]
```

```{r}
clusters <- readRDS(paste0(kDataPath, 'clusters_annotated.rds'))
clusters[(clusters == 'pre-B cells 1') | (clusters == 'pre-B cells 2')] <- 'pre-B cells'
```

## Rescued cells
```{r, message=FALSE}
r_rescued <- GetPagoda(r_cm_rescued, n.cores=30)
```

```{r}
intersect_clusters <- clusters[intersect(names(clusters), intersect_cbs)]
notannotated_cells <- setdiff(colnames(r_cm_rescued), names(clusters))

clusters_annotated_resc <- AnnotateClustersByGraph(r_rescued$graphs$PCA, clusters, 
                                                   notannotated_cells, max.iter=100, 
                                                   mc.cores=10)
rescued_clusters <- clusters_annotated_resc[rescued_cbs]
intersect_clusters <- clusters[intersect_cbs]
```

```{r, fig.width=4, fig.height=4.8}
plot_clusters <- clusters[names(clusters) %>% setdiff(rescued_cbs) %>% setdiff(filtered_cbs)]
gg_tsne <- PlotFiltrationResults(r_rescued, plot_clusters, filtered.cbs=filtered_cbs, 
                                 rescued.clusters=rescued_clusters, 
                                 raster.width=4, raster.height=4.8) +
  ylim(-35, 33) +
  theme_pdf(legend.pos=c(0, 1), show.ticks = F)

gg_tsne
```

### Seurat analysis
```{r, message=FALSE, warning=FALSE}
seurat_cm <- r_cm_rescued[Matrix::rowSums(r_cm_rescued) > 200, ]
srt <- CreateSeuratObject(raw.data=r_cm_rescued, project="SCG71")
srt <- NormalizeData(object=srt, normalization.method="LogNormalize", scale.factor=10000)
srt <- FindVariableGenes(object=srt, mean.function=ExpMean, dispersion.function=LogVMR,
                         x.low.cutoff = 0.0125, x.high.cutoff = 3, y.cutoff = 1, do.plot=F)
srt <- ScaleData(object = srt, vars.to.regress = "nUMI")

save(srt, file = "~/tmp_exchange/scg71_srt.Robj")

load("~/tmp_exchange/scg71_srt.Robj")
```

```{r}
srt@ident <- as.factor(clusters_annotated_resc[colnames(srt@raw.data)])
names(srt@ident) <- colnames(srt@raw.data)
compared_clusters <- unique(srt@ident)
cluster_markers <- mclapply(compared_clusters, function(i) mclapply(setdiff(compared_clusters, i), FindClusterMarkers, i, srt, mc.cores=4), mc.cores=11)
```

```{r}
overexpressed_genes <- GetOverexpressedGenes(srt, compared_clusters, cluster_markers)
length(overexpressed_genes)

clusters_info <- list(clusters=srt@ident, marks=cluster_markers, overexpressed_genes=overexpressed_genes)
saveRDS(clusters_info, '~/tmp_exchange/SCG71_cluster_markers.rds')
```

```{r}
clusters_info <- readRDS('~/tmp_exchange/SCG71_cluster_markers.rds')
```

## Heatmaps
```{r}
tested_clusts <- sort(c(intersect_clusters, rescued_clusters))
# tested_clusts <- tested_clusts[tested_clusts != 'Macrophages']
separation <- c(setNames(rep('rescued', length(rescued_cbs)), rescued_cbs),
                setNames(rep('real', length(intersect_clusters)), names(intersect_clusters)))

umis_per_cb_subset <- log10(Matrix::colSums(r_cm_rescued[, names(tested_clusts)]))
tested_clusts <- tested_clusts[order(tested_clusts, -umis_per_cb_subset)]

# de_genes <- intersect(colnames(r_rescued$counts), clusters_info$overexpressed_genes)
de_genes <- clusters_info$overexpressed_genes

# as.matrix(r_rescued$counts[names(tested_clusts), de_genes])
```

```{r, fig.width=6, fig.height=7}
plot_df <- ExpressionMatrixToDataFrame(r_rescued$counts[names(tested_clusts), de_genes],
                                       umis_per_cb_subset, as.factor(tested_clusts),
                                       filtration.type=separation)
plot_df <- plot_df %>% filter(UmisPerCb < 2.83) #%>% filter(Cluster %in% Reduce(intersect, split(plot_df$Cluster, plot_df$FiltrationType)))
plot_dfs <- split(plot_df, plot_df$FiltrationType)


ggs <- lapply(plot_dfs, HeatmapAnnotGG, umi.per.cell.limits=range(plot_df$UmisPerCb))
gg_legends <- mapply(`+`, ggs$real, list(HeatmapLegendGuide('Expression'),
                                    HeatmapLegendGuide('Cell type', guide=guide_legend, ncol=3),
                                    HeatmapLegendGuide('log10(#molecules)')), SIMPLIFY=F) %>%
  lapply(`+`, theme(legend.margin=margin(l=4, r=4, unit='pt'))) %>% lapply(get_legend)

ggs$real$heatmap <- ggs$real$heatmap + rremove('xlab') + ylab('Cells')
ggs$rescued$heatmap <- ggs$rescued$heatmap + labs(x = 'Genes', y = 'Cells')
ggs_annot <- lapply(ggs, function(gg) cowplot::plot_grid(plotlist=lapply(gg, `+`, theme(legend.position="none", plot.margin=margin())), 
                                                         nrow=1, rel_widths=c(1.5, 0.1, 0.1), align='h'))
# gg_legends_plot <- cowplot::plot_grid(plotlist=gg_legends, nrow=3, align='v')
```

## Aggregated tSNE plot
```{r, fig.width=8, fig.height=6}
gg_left <- cowplot::plot_grid(ggs_annot$real, ggs_annot$rescued, nrow=2, labels=c('A', 'B'))
gg_right <- gg_tsne + theme(plot.margin=margin(l=0.1, unit='in'), axis.text=element_blank(), axis.ticks=element_blank())
gg_bottom <- cowplot::plot_grid(plotlist=gg_legends[c(1, 3, 2)], ncol=3, rel_widths=c(1, 1, 2.2))

gg_fig <- cowplot::plot_grid(gg_left, gg_right, labels=c('', 'C'), ncol=2) %>%
  cowplot::plot_grid(gg_bottom, nrow=2, rel_heights=c(1, 0.25), align='v')

gg_fig
ggsave(paste0(kPlotsFolder, 'SCG71_figure.pdf'), gg_fig)
```
