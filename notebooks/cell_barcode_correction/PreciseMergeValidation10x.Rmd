---
title: "Precise Merge Validation"
output:
  html_document:
    df_print: kable
    number_sections: yes
    theme: cerulean
    toc: yes
  html_notebook: default
---

# Initialization
```{r global_options, include=FALSE}
library(ggplot2)
library(ggsci)
library(ggpubr)
library(dplyr)
library(parallel)
library(dropestr)
library(reshape2)
library(Matrix)

source("../Functions/PlotFuncs.R")
source("../Functions/Functions.R")

knitr::opts_chunk$set(fig.width=5, fig.height=3, echo=FALSE, warning=FALSE, message=FALSE)
theme_set(theme_base)

kPlotsFolder <- '~/Data/Plots/PaperReview/CBMerge/'
```

```{r}
kCellNum <- 34000
kDatasetName <- 'pbmc33k'
kDataPath <- paste0('/d0-mendel/home/viktor_petukhov/Data/10x/', kDatasetName, '/')
kDataFolders <- c(poisson='est_11_17_poisson/', real='est_11_17_real/', unmerged='est_11_17_unmerged/', merge_all='est_01_11_all/') #, simple='est_11_17_simple/'
holders <- mclapply(kDataFolders, function(folder) readRDS(paste0(kDataPath, folder, kDatasetName, '_no_umis.rds')), mc.cores=length(kDataFolders))
length(holders)
# for (n in names(holders)) {
#   holders[[n]]$reads_per_umi_per_cell <- NULL
#   saveRDS(paste0(kDataFolders, kDatasetName, '_no_umis.rds'))
# }
```

```{r}
merge_targets <- lapply(holders, function(holder) unlist(holder$merge_targets))
umis_per_cb <- lapply(holders, function(holder) sort(Matrix::colSums(holder$cm_raw), decreasing=T))

for (n in names(umis_per_cb)) {
  names(umis_per_cb[[n]]) <- substr(names(umis_per_cb[[n]]), 1, 14)
  filt_cbs <- substr(names(umis_per_cb[[n]]), 1, 14) %>% table() %>% (function(x) names(x)[x == 1])
  umis_per_cb[[n]] <- umis_per_cb[[n]][filt_cbs]
}
```

```{r}
lapply(umis_per_cb, EstimateCellsNumber) %>% bind_rows() %>% mutate(Merge=names(umis_per_cb))
real_cbs <- names(sort(umis_per_cb$real, decreasing=T))[1:33148]
min(umis_per_cb$real[real_cbs])

lapply(merge_targets, function(x) mean(real_cbs %in% names(x)))

PlotCellsNumberLine(umis_per_cb$merge_all)
```


```{r, fig.width=6, fig.height=4, warning=FALSE, message=FALSE}
linewidth <- 1
alpha <- 0.7
gg1 <- PlotCellsNumberLogLog(umis_per_cb$real, plot.label='Poisson, real barcodes', plot.border=F, linewidth=linewidth, alpha=alpha)
gg2 <- PlotCellsNumberLogLog(umis_per_cb$poisson, gg.base=gg1, plot.label='Poisson, no barcodes', plot.border=F, linewidth=linewidth, alpha=alpha)
gg3 <- PlotCellsNumberLogLog(umis_per_cb$unmerged, gg.base=gg2, plot.label='No merge', plot.border=F, linewidth=linewidth, alpha=alpha)
gg4 <- PlotCellsNumberLogLog(umis_per_cb$merge_all, gg.base=gg3, plot.label='Simple, no barcodes', plot.border=F, linewidth=linewidth, alpha=alpha)

gg_merge_sizes <- gg4 + 
  guides(color=guide_legend(title='Merge type')) +
  scale_color_hue(l=55) +
  theme_pdf(legend.pos=c(1, 1))

gg_merge_sizes
ggsave(filename=paste0(kPlotsFolder, 'merge_sizes.pdf'), plot=gg_merge_sizes, width=6, height=4)
```

```{r}
gg1 <- PlotCellsNumberLogLog(umis_per_cb$real, plot.label='Poisson, real barcodes', plot.border=F, linewidth=linewidth, alpha=alpha)
gg2 <- PlotCellsNumberLogLog(umis_per_cb$unmerged[names(umis_per_cb$real)], gg.base=gg1, plot.label='No merge', plot.border=F, linewidth=linewidth, alpha=alpha)

common_umis <- intersect(names(umis_per_cb$real), names(umis_per_cb$unmerged))

qplot((umis_per_cb$real[common_umis] - umis_per_cb$unmerged[common_umis]) / umis_per_cb$unmerged[common_umis], bins=100) + xlim(0, 0.25)

ggplot() + geom_line(aes(x=1:length(umis_per_cb$real), y=sort(umis_per_cb$real, decreasing=T), color='Merged')) +
  geom_line(aes(x=1:length(intersect(names(umis_per_cb$real), names(umis_per_cb$unmerged))), y=sort(umis_per_cb$unmerged[names(umis_per_cb$real)], decreasing=T), color='Not merged'))


gg2 + 
  guides(color=guide_legend(title='Merge type')) +
  scale_color_hue(l=55) +
  theme_pdf(legend.pos=c(1, 1))
```

```{r}
gg1 <- PlotCellsNumberLine(umis_per_cb$real, plot.label='Real barodes merge', breaks=50)
gg2 <- PlotCellsNumberLine(umis_per_cb$poisson, gg.base=gg1, plot.label='No barcodes merge', breaks=50)
gg3 <- PlotCellsNumberLine(umis_per_cb$unmerged, gg.base=gg2, plot.label='No merge', breaks=50)
gg4 <- PlotCellsNumberLine(umis_per_cb$merge_all, gg.base=gg3, plot.label='Merge all', breaks=50)

gl <- guide_legend(title='Merge type')
gg4 +
  scale_x_continuous(limits=c(0, 50000), expand=c(0.01, 0.01)) +
  scale_y_continuous(limits=c(0, 1.5e7), expand=c(0.01, 0.01)) +
  # scale_fill_npg(alpha=0.6) +
  guides(fill=gl, linetype=gl) + theme_pdf(legend.pos=c(1, 1))

# ggsave(paste0(kPlotsFolder, 'cell_number_ridges.', kDatasetName, '.pdf'), width=4, height=4)
```

# Differences analysis
```{r}
library(pagoda2)
```

```{r}
r_real <- GetPagoda(holders$real$cm[,names(sort(Matrix::colSums(holders$real$cm))[1:kCellNum])], n.cores=20)
r_simple <- GetPagoda(holders$simple$cm[,names(sort(Matrix::colSums(holders$simple$cm))[1:kCellNum])], n.cores=20)

r_unmerged <- Pagoda2$new(holders$unmerged$cm_raw, modelType='plain', trim=5, n.cores=20)
r_unmerged$adjustVariance(plot=F, do.par=F, gam.k=10)
```

```{r}
PlotPagodaEmbeding(r_real, clustering.type='infomap', mark.clusters=T, show.legend=F, min.cluster.size=100)
PlotPagodaEmbeding(r_simple, clustering.type='infomap', mark.clusters=T, show.legend=F, min.cluster.size=100)
```

```{r}
merge_info <- list(real=list(), simple=list(), poisson=list())

merge_info$real$target_clusters <- r_real$clusters$PCA$infomap[r_real$clusters$PCA$infomap %in% 1:5]
uniq_cbs <- substr(names(merge_info$real$target_clusters), 1, 14)
merge_info$real$target_clusters <- merge_info$real$target_clusters[uniq_cbs %in% names(table(uniq_cbs))[table(uniq_cbs) == 1]]
names(merge_info$real$target_clusters) <- substr(names(merge_info$real$target_clusters), 1, 14)

# merge_info$real$merge_targets <- merge_targets$real[merge_targets$real %in% names(merge_info$real$target_clusters)]
# merge_info$real$base_clusters <- setNames(merge_info$real$target_clusters[merge_info$real$merge_targets], names(merge_info$real$merge_targets))
# merge_info$real$bases_cm <- r_unmerged$counts[intersect(rownames(r_unmerged$counts), names(merge_info$real$merge_targets)),]
# merge_info$real$targets_cm <- r_unmerged$counts[intersect(rownames(r_unmerged$counts), merge_info$real$merge_targets),]

merge_info$simple$merge_targets <- merge_targets$simple[merge_targets$simple %in% names(merge_info$real$target_clusters)]
merge_info$simple$base_clusters <- setNames(merge_info$real$target_clusters[merge_info$simple$merge_targets], names(merge_info$simple$merge_targets))
merge_info$simple$bases_cm <- r_unmerged$counts[intersect(rownames(r_unmerged$counts), names(merge_info$simple$merge_targets)),]

merge_info$poisson$merge_targets <- merge_targets$poisson[merge_targets$poisson %in% names(merge_info$real$target_clusters)]
merge_info$poisson$base_clusters <- setNames(merge_info$real$target_clusters[merge_info$simple$merge_targets], names(merge_info$simple$merge_targets))
merge_info$poisson$bases_cm <- r_unmerged$counts[intersect(rownames(r_unmerged$counts), names(merge_info$simple$merge_targets)),]
```

```{r}
sort(umis_per_cb$unmerged[names(merge_info$real$base_clusters)], decreasing=T)
sort(umis_per_cb$unmerged[names(merge_info$all$base_clusters)], decreasing=T)
sort(umis_per_cb$unmerged[names(merge_info$simple$base_clusters)], decreasing=T)
```

# Heatmaps
```{r}
library(ComplexHeatmap)
library(circlize)
library(RColorBrewer)

r_real$getDifferentialGenes(type='PCA', clusterType = 'infomap')
de_genes <- Reduce(union, lapply(r_real$diffgenes$PCA$infomap, function(x) rownames(x)[1:min(100, nrow(x))]))
de_genes <- de_genes[!is.na(de_genes)]
de_genes <- de_genes[grep("^[^;]+$", de_genes)]
```

```{r}
PrepareBaseHeatmap <- function(mtx, annotation.df, h.clust.columns, show_heatmap_legend=T, row_title='', column_title='', column_dend=F) {
  hm.base <- Heatmap(mtx[rownames(annotation.df),], 
                   cluster_rows=F, cluster_columns=h.clust.columns, name = "log10(expression)", 
                   show_heatmap_legend=show_heatmap_legend, show_row_names = F, show_column_names = F, show_column_dend=column_dend,
                   column_dend_height=unit(0.3, 'in'),
                   heatmap_legend_param=list(legend_direction = "horizontal", legend_width=unit(2, 'in')),
                   col=colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(100),
                   row_title=row_title, column_title=column_title, column_title_side='bottom')
  return(hm.base)
}

PrepareHeatmapAnnotation <- function(annotation.df, colors, show_legend=F) {
  annotation <- HeatmapAnnotation(df=annotation.df, which = "row", 
                                 annotation_legend_param = list(
                                   UmisPerCell = list(title = "log10(#molecules per cell)", legend_direction = "horizontal", 
                                                      color_bar='continuous', legend_width=unit(2, 'in')), 
                                   Cluster = list(title = "Cluster", legend_direction = "horizontal", nrow=1, legend_gap=unit(c(1, 1), 'in'))),
                                 col=colors, show_legend=show_legend)
  
  return(annotation)
}

AnnotationDf <- function(clusters, umis_per_cb) {
  return(data.frame(row.names=names(clusters), UmisPerCell=umis_per_cb[names(clusters)], Cluster=clusters))
}
```

```{r}
umi_threshold <- 500
umi_threshold_upper <- 2000
clusters_real <- merge_info$real$target_clusters[(umis_per_cb$unmerged[names(merge_info$real$target_clusters)] > umi_threshold) &
                                                   umis_per_cb$unmerged[names(merge_info$real$target_clusters)] < umi_threshold_upper]
clusters_real <- clusters_real[order(clusters_real, -umis_per_cb$unmerged[names(clusters_real)])]
clusters_real <- clusters_real[names(clusters_real) %in% rownames(r_unmerged$counts)]

base_clusters <- lapply(merge_info, function(mi) mi$base_clusters[umis_per_cb$unmerged[names(mi$base_clusters)] > umi_threshold])
base_clusters$real <- NULL
base_clusters <- lapply(base_clusters, function(cl) cl[order(cl, -umis_per_cb$unmerged[names(cl)])])

m_real <- log10(1e-6 + as.matrix(r_unmerged$counts[names(clusters_real), de_genes]))
m_base <- lapply(base_clusters, function(cl) log10(1e-6 + as.matrix(r_unmerged$counts[names(cl), de_genes])))

h_clust_col <- hclust(dist(t(m_real)))

annotation_real <- AnnotationDf(clusters_real, umis_per_cb$unmerged)
annotation_base <- lapply(base_clusters, AnnotationDf, umis_per_cb$unmerged)

clusts <- unique(annotation_real$Cluster)
colors_lst <- list(UmisPerCell=colorRamp2(breaks=seq(min(annotation_real$UmisPerCell), max((annotation_real$UmisPerCell)), length.out=100), 
                                          colors=colorRampPalette(brewer.pal(n = 9, name = "OrRd"))(100)),
                   # Cluster=setNames(scales::hue_pal(l=50)(length(clusts)), clusts))
                   Cluster=setNames(colorRampPalette(rev(brewer.pal(n = length(clusts), name = "Dark2")))(length(clusts)), clusts))
```

```{r}
hm_real <- PrepareBaseHeatmap(m_real, annotation_real, h_clust_col, show_heatmap_legend=F, column_dend=T, row_title='', column_title='')
ha_real <- PrepareHeatmapAnnotation(annotation_real, colors_lst, show_legend=F)

show_legend <- setNames(c(F, T, F), names(annotation_base))
show_annot_legend <- setNames(c(F, F, T), names(annotation_base))
show_dend <- setNames(c(T, F, F), names(annotation_base))

hm_base <- list()
ha_base <- list()
for (n in names(m_base)) {
  hm_base[[n]] <- PrepareBaseHeatmap(m_base[[n]], annotation_base[[n]], h_clust_col, show_heatmap_legend=show_legend[[n]], column_dend=show_dend[[n]], row_title='', column_title='')
  ha_base[[n]] <- PrepareHeatmapAnnotation(annotation_base[[n]], colors_lst, show_legend=show_annot_legend[[n]])
}
```

```{r, fig.width=8, fig.height=9}
draw(hm_real + ha_real, padding = unit(c(4.6, 0, 0, 3.95), "in"))
draw(hm_base$simple + ha_base$simple, newpage=F, padding = unit(c(4.6, 4.1, 0, 0), "in"))
draw(hm_base$poisson + ha_base$poisson, newpage=F, padding = unit(c(0, 0, 4.6, 3.95), "in"), heatmap_legend_side='bottom', annotation_legend_side='bottom')
```

```{r, fig.width=8, fig.height=4}
annotation_df_s <- split(annotation_df, annotation_df$CellType)

annotation_df_cur <- annotation_df_s$Base %>% dplyr::select(-CellType)
hm_base <- PrepareBaseHeatmap(m_subset, annotation_df_cur, h_clust_col, show_heatmap_legend=F, column_dend=T, row_title='Cells', column_title='')
ha_base <- PrepareHeatmapAnnotation(annotation_df_cur, colors_lst, show_legend=F)

annotation_df_cur <- annotation_df_s$Filtered %>% dplyr::select(-CellType)
hm_filt <- PrepareBaseHeatmap(m_subset, annotation_df_cur, h_clust_col, show_heatmap_legend=T, column_dend=F, row_title='Cells', column_title='Genes')
ha_filt <- PrepareHeatmapAnnotation(annotation_df_cur, colors_lst, show_legend=T)

annotation_df_cur <- annotation_df_s$Rescued %>% dplyr::select(-CellType)
hm_rescued <- PrepareBaseHeatmap(m_subset, annotation_df_cur, h_clust_col, show_heatmap_legend=F, column_dend=T, row_title='', column_title='Genes')
ha_rescued <- PrepareHeatmapAnnotation(annotation_df_cur, colors_lst, show_legend=F)
```

```{r, fig.width=8, fig.height=8}
# pdf(paste0(kPlotsFolder, 'filtered_genes_heatmap.pdf'), width=8, height=8, paper='special')
# png(paste0(kPlotsFolder, 'filtered_genes_heatmap.png'), width=8, height=8, units='in', res=300)
draw(hm_base + ha_base, padding = unit(c(4.02, 0, 0, 3.9), "in"))
draw(hm_rescued + ha_rescued, newpage=F, padding = unit(c(3.66, 4.2, 0, 0), "in"))
draw(hm_filt + ha_filt, newpage=F, padding = unit(c(0, 0, 4.02, 1.83), "in"), heatmap_legend_side='right', annotation_legend_side='right')
# dev.off()
```






# Other
```{r}
PlotPagodaEmbeding(r_real, clustering.type='infomap', show.legend=F, min.cluster.size=70, mark.clusters=T, alpha=0.5, size=0.5, font.size=4.5) + 
  theme_pdf(F)
```

```{r}
PlotPagodaEmbeding(r_all, clustering.type='infomap', show.legend=F, min.cluster.size=70, mark.clusters=T, alpha=0.5, size=0.5, font.size=4.5) + 
  theme_pdf(F)
```

```{r}
length(as.factor(c(rep(0, kCellNum), rep(1, ncol(false_negative_cm)))))
dim(r$counts)
```

```{r}
class_labels <- c(setNames(rep(0, kCellNum), cbs$real_poisson[1:kCellNum]), setNames(rep(1, ncol(false_negative_cm)), colnames(false_negative_cm)))
class_labels <- as.factor(class_labels)

r$plotEmbedding(type='PCA', embeddingType = 'tSNE', groups=class_labels, show.legend=T, mark.clusters=F, 
                min.group.size=50, shuffle.colors=F, mark.cluster.cex=1, alpha=0.5, quiet=T)
```


# False positive rate
```{r}
holder <- readRDS('/d0-mendel/home/viktor_petukhov/Data/SRR1784310/est_11_07_unmerged/SRR1784310.rds')
# holder <- readRDS('/d0-mendel/home/viktor_petukhov/Data/SCG71/est_11_08_unmerged/SCG71.rds')
validation_info  <- holder$merge_validation_info
```

```{r}
fracs <- c(10^seq(-12, 0, 0.1), 1)
observed_fracs <- unlist(mclapply(fracs, function(frac) mean(validation_info$distant$Probability <= frac), mc.cores=20))

observed_fracs_adj <- unlist(mclapply(fracs, function(frac) mean(validation_info$adjacent$Probability <= frac), mc.cores=20))

qplot(fracs, observed_fracs, color='Edit distance > 5') + geom_line(size=1) + 
  geom_line(aes(x=fracs, y=observed_fracs_adj, color='Edit distance == 1'), size=1) +
  geom_line(aes(fracs, fracs, colour='y=x'), size=1, alpha=0.8) + 
  scale_color_manual(name=NULL, values=c("#2D802D", "#35419C", 'black')) +
  scale_x_log10(limits=c(3e-8, 1)) + scale_y_log10(limits=c(1e-5, 1.1)) + 
  legend_pos(5e-3, 1)
```
